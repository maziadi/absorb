#!/bin/bash

ACTIVEMQ_VERSION=5.5.1

function mail_alert() {
<%- if (environment == "production") -%>
echo "Subject: <%= hostname %> - Queues de CDR : ${1} d'incident
To: noc-alerts@alphalink.fr
Cc: a.moutot@alphalink.fr
Cc: c.leroy@alphalink.fr
Cc: e.taque@alphalink.fr

Nombre de CDR LOG en queue : ${2}
Etat de cdr-archiver sur <%= hostname %> : ${3}
" | /usr/sbin/ssmtp noc-alerts@alphalink.fr a.moutot@alphalink.fr c.brancourt@alphalink.fr e.taque@alphalink.fr
<%- else -%>
echo "Subject: <%= hostname %> - Queues de CDR : ${1} d'incident
To: dev-noc-alerts@alphalink.fr
Cc: a.moutot@alphalink.fr

Nombre de CDR LOG en queue : ${2}
Etat de cdr-archiver sur <%= hostname %> : ${3}
" | /usr/sbin/ssmtp dev-noc-alerts@alphalink.fr a.moutot@alphalink.fr
<%- end -%>
}

function activate_cdr_archiver() {
  ca_pid=$(cat /var/run/cdr-archiver-cbv?.pid 2> /dev/null)
  kill -0 $ca_pid 2> /dev/null
  if [ $? -eq 1 ]
  then
    /etc/init.d/cdr-archiver-cbv? start
  else
    kill -1 $ca_pid
  fi
}

function deactivate_cdr_archiver() {
  ca_pid=$(cat /var/run/cdr-archiver-cbv?.pid 2> /dev/null)
  kill -0 $ca_pid 2> /dev/null
  if [ $? -eq 0 ]
  then
    /etc/init.d/cdr-archiver-cbv? stop > /dev/null 2>&1
  fi
}

#
# MAIN
#


if [ -f /var/run/cdr-archiver-cbv?.pid ]
then
  activate_cdr_archiver
else
  nbcdr=$(/opt/local/apache-activemq-${ACTIVEMQ_VERSION}/bin/activemq-admin query --jmxurl service:jmx:rmi:///jndi/rmi://<%= active_mq_service_addr -%>:1616/jmxrmi --jmxuser monitorRole --jmxpassword kaoHaes0iote -QQueue=sigal.cdr  --view QueueSize | grep QueueSize | cut -c 13- )
  if [ $nbcdr -gt 30000000 ]
  then
    activate_cdr_archiver
    mail_alert debut $nbcdr actif
  fi
fi
