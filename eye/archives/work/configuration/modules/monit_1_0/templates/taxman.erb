check process voip
  with pidfile "/var/run/taxman/taxman_voip.pid"
  start program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/voip start --piddir /var/run/taxman'"
  stop program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/voip stop --piddir /var/run/taxman'"
  group taxerp

check device mongofs with path /var/lib/mongodb
    alert <%= monit_conf_alert_email %> 
    if space usage > 60% for 5 times within 15 cycles then alert
    if inode usage > 80% for 5 times within 15 cycles then alert 
check device datafs with path /data
    alert <%= monit_conf_alert_email %> 
    if space usage > 80% for 5 times within 15 cycles then alert
    if inode usage > 90% for 5 times within 15 cycles then alert 

<% if webserver_taxman %>
check process taxman
  with pidfile "/var/run/taxman/taxman.pid"
  start program = "/bin/su - taxman -c 'export RAILS_ENV=<%= taxman_env %>; bundle exec mizuno -E <%= taxman_env %> -o <%= taxman_ip %> -p <%= taxman_port %> -P /var/run/taxman/taxman.pid --threads 6 -D'" 
  stop program = "/bin/su - taxman -c 'kill $(cat /var/run/taxman/taxman.pid)'"
  group taxerp

check process nginx
  with pidfile "/var/run/nginx.pid"
  alert <%= monit_conf_alert_email %>

check process messenger
  with pidfile "/var/run/taxman/taxman_messenger.pid"
  start program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/messenger start --piddir /var/run/taxman'"
  stop program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/messenger stop --piddir /var/run/taxman'"
  group taxerp

check process mobile
  with pidfile "/var/run/taxman/taxman_mobile.pid"
  start program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/mobile start --piddir /var/run/taxman'"
  stop program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/mobile stop --piddir /var/run/taxman'"
  group taxerp

check process cashbot
  with pidfile "/var/run/taxman/taxman_cashbot.pid"
  start program = "/bin/su - taxman -c 'export APN_HOST=<%= taxman_apn_ip %> ; export APN_PORT=<%= taxman_apn_port %>; RAILS_ENV=<%= taxman_env %> bundle exec script/cashbot start --piddir /var/run/taxman'"
  stop program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/cashbot stop --piddir /var/run/taxman'"
  group taxerp

check process jobs
  with pidfile "/var/run/taxman/taxman_jobs.pid"
  start program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/jobs start --piddir /var/run/taxman'"
  stop program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/jobs stop --piddir /var/run/taxman'"
  alert <%= monit_conf_alert_email %>
  group taxerp

check process outback
  with pidfile "/var/run/taxman/taxman_outback.pid"
  start program = "/bin/su - taxman -c 'JRUBY_OPTS="-J-XX:PermSize=256M -J-XX:MaxPermSize=512M -J-Xmx1024m" RAILS_ENV=<%= taxman_env %> bundle exec script/outback start --piddir /var/run/taxman'"
  stop program = "/bin/su - taxman -c 'RAILS_ENV=<%= taxman_env %> bundle exec script/outback stop --piddir /var/run/taxman'"
  alert <%= monit_conf_alert_email %>
  group taxerp
<% end %>
