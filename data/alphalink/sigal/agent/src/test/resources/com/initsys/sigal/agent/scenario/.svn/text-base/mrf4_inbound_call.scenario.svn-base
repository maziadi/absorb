Scenario: nominal, e164/e164
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: nominal, e164/e164 avec un + dans le numero appele
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to +33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: nominal, national/national
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <0123456788> to 0123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: national, in_plan: national, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456788 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33123456788/Jean Bon -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33123456788/Jean Bon -- i/<any>/33123456789
  Then done

Scenario: nominal, e164/e164 (transition vers VNO)
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: vno.default, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: vno.default
  Then cdr <any>/vno.default - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/vno.default - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: nominal, e164/164, lock du compte
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: true, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then hangup with cause 31
  Given answered time 0
  Then complete cdr <any>/480_LimitReached/0/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: mrf4 numero court 118xyz in_plan national
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 123, gw_channel_name: SIP/GW
  Given a call from Jean Bon <0123456789> to 118123
  Given account code <null>
  Given header X-AccountCode: 0991000001099
  Given header Privacy: <null>
  Then query EXDB with 0991000001099 returning out_plan: national, in_plan: national, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456789 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001099
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/015118123
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 015118123, timeout 123 and separator , 
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/015118123
  Then done

Scenario: mrf4 numero court 10yx in_plan national
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 123, gw_channel_name: SIP/GW
  Given a call from Jean Bon <0123456789> to 1012
  Given account code <null>
  Given header X-AccountCode: 0991000001099
  Given header Privacy: <null>
  Then query EXDB with 0991000001099 returning out_plan: national, in_plan: national, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456789 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001099
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0151012
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 0151012, timeout 123 and separator , 
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0151012
  Then done

Scenario: mrf4 numero court 3bpq in_plan national
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 123, gw_channel_name: SIP/GW
  Given a call from Jean Bon <0123456789> to 3123
  Given account code <null>
  Given header X-AccountCode: 0991000001099
  Given header Privacy: <null>
  Then query EXDB with 0991000001099 returning out_plan: national, in_plan: national, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456789 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001099
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0153123
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 0153123, timeout 123 and separator , 
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0153123
  Then done

Scenario: mrf4 numero court 118xyz in_plan e164
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 123, gw_channel_name: SIP/GW
  Given a call from Jean Bon <33123456789> to 33118123
  Given account code <null>
  Given header X-AccountCode: 0991000001099
  Given header Privacy: <null>
  Then query EXDB with 0991000001099 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456789 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001099
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/015118123
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 015118123, timeout 123 and separator , 
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/015118123
  Then done

Scenario: mrf4 numero court 10yx in_plan e164
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 123, gw_channel_name: SIP/GW
  Given a call from Jean Bon <33123456789> to 331012
  Given account code <null>
  Given header X-AccountCode: 0991000001099
  Given header Privacy: <null>
  Then query EXDB with 0991000001099 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456789 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001099
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0151012
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 0151012, timeout 123 and separator , 
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0151012
  Then done

Scenario: mrf4 numero court 3bpq in_plan e164
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 123, gw_channel_name: SIP/GW
  Given a call from Jean Bon <33123456789> to 333123
  Given account code <null>
  Given header X-AccountCode: 0991000001099
  Given header Privacy: <null>
  Then query EXDB with 0991000001099 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456789 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001099
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0153123
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 0153123, timeout 123 and separator , 
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001099/+33123456789/Jean Bon -- i/<any>/0153123
  Then done

Scenario: avec identification, sans P-Asserted-Identity
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity en <tel:numero>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <tel:33111111111>
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33111111111/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33111111111/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity en <tel:+numero>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <tel:+33111111111>
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33111111111/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33111111111/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity - variante <sip:user>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <sip:foo>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity - variante <sip:number>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <sip:33111111111>
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33111111111/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33111111111/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity - variante <sip:user@host>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <sip:foo@bar>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity - variante "Name" <sip:user@host>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: "Foo Bar" <sip:foo@bar>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec identification, avec P-Asserted-Identity - variante "Name" <sip:33000000002@host>
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: "Foo Bar" <sip:33000000002@bar>
  Then add header P-Asserted-Identity: <tel:+33000000002>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000002/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000002/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: nominal, national/national, avec P-Asserted-Identity - tel:0100000002
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <0123456788> to 0123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: national, in_plan: national, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33123456788 and Jean Bon
  Given header P-Asserted-Identity: <tel:0100000002>
  Then add header P-Asserted-Identity: <tel:+33100000002>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33123456788/+33100000002/ALLOWED/Jean Bon -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33123456788/+33100000002/ALLOWED/Jean Bon -- i/<any>/33123456789
  Then done

Scenario: e164 - From: anonymous
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Anonymous <anonymous> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to anonymous and Anonymous
  Given header P-Asserted-Identity: <sip:33111111111>
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/anonymous/+33111111111/ALLOWED/Anonymous -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/anonymous/+33111111111/ALLOWED/Anonymous -- i/<any>/33123456789 
  Then done

Scenario: national - From: anonymous
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Anonymous <anonymous> to 0123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: national, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to anonymous and Anonymous
  Given header P-Asserted-Identity: <sip:0111111111>
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/anonymous/+33111111111/ALLOWED/Anonymous -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/anonymous/+33111111111/ALLOWED/Anonymous -- i/<any>/33123456789 
  Then done

Scenario: e164 - From: 089
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from tutu <0899124356> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: national, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +0899124356 and tutu
  Given header P-Asserted-Identity: <sip:0111111111>
  Then add header Privacy: id
  Then add header P-Asserted-Identity: <tel:+0111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+0899124356/+0111111111/RESTRICTED/tutu -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+0899124356/+0111111111/RESTRICTED/tutu -- i/<any>/33123456789 
  Then done

Scenario: e164 - From: 3389
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Tutu <33899124358> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33899124358 and Tutu
  Given header P-Asserted-Identity: <sip:33111111111>
  Then add header Privacy: id
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33899124358/+33111111111/RESTRICTED/Tutu -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33899124358/+33111111111/RESTRICTED/Tutu -- i/<any>/33123456789 
  Then done

Scenario: e164 - From: 003389
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Tutu <0033899124358> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +0033899124358 and Tutu
  Given header P-Asserted-Identity: <sip:33111111111>
  Then add header Privacy: id
  Then add header P-Asserted-Identity: <tel:+33111111111>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+0033899124358/+33111111111/RESTRICTED/Tutu -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+0033899124358/+33111111111/RESTRICTED/Tutu -- i/<any>/33123456789 
  Then done

Scenario: Privacy invalide
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: invalide
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/ALLOWED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: Privacy: id
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: id
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Then add header Privacy: id
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/RESTRICTED/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/+33000000001/RESTRICTED/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec un niveau de failover - timeout et peer inconu - devrait etre le meme cas que 408
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 111
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec un niveau de failover - timeout et peer inconu - annulation apres avoir reussi le fail-over
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 111
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status CANCEL
  Then hangup with cause 0
  Given answered time 0
  Then complete cdr <any>/487_Cancelled/0/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec un niveau de failover - 408
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 18
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: failover echoue
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 18
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 18
  Given dial status CHANUNAVAIL
  Then hangup with cause 19
  Given answered time 0
  Then complete cdr <any> 480/NoGatewayAvailable 0
  Then done

Scenario: avec plusieurs niveaux de failover - 500 a 504
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2,SIP/GW3,SIP/GW4,SIP/GW5,SIP/GW6
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 6 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 38
  Given dial status CHANUNAVAIL
  Then rand 0 with 5 gateways
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 29
  Given dial status CHANUNAVAIL
  Then rand 0 with 4 gateways
  Then dial channel SIP/GW3 with number 33123456789, timeout 121 and separator ,
  Given release cause 27
  Given dial status CHANUNAVAIL
  Then rand 0 with 3 gateways
  Then dial channel SIP/GW4 with number 33123456789, timeout 121 and separator ,
  Given release cause 34
  Given dial status CHANUNAVAIL
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW5 with number 33123456789, timeout 121 and separator ,
  Given release cause 102
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW6 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec un niveau de failover - code par défaut pour la plage 5XX
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 34
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: avec un niveau de failover - le probing a detecte que routag ne repond pas
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 20
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: loadbalancing, tirage de la premiere gateways
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: loadbalancing, tirage de la seconde gateways
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33000000001
  Then set callerId to +33000000000 and Jean Bon
  Given header P-Asserted-Identity: <null>
  Then add header P-Asserted-Identity: <tel:+33000000001>
  Then add header X-AccountCode: 0991000001017
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then rand 1 with 2 gateways
  Then dial channel SIP/GW2 with number 33123456789, timeout 121 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001017/+33000000000/Jean Bon -- i/<any>/33123456789 
  Then done

Scenario: EXDB returns nothing when querying with AccountCode
  Given mrf4.Mrf4InboundAgi and inbound_timeout: 121, gw_channel_name: SIP/GW
  Given a call from Jean Bon <+33000000000> to 33123456789
  Given account code <null>
  Given header X-AccountCode: 0991000001017
  Given header Privacy: <null>
  Then query EXDB with 0991000001017 and find nothing
  Then hangup with cause 21
  Given answered time 0
  Then complete cdr <any> 403/AccountNotFound 0
  Then done
