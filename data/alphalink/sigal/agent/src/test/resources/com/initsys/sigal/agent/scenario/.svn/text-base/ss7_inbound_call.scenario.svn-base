Scenario: nominal
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: No account code and not a redirect : SMG003-CPC-010
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code <null>
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then hangup with cause 1
  Given answered time 0
  Then complete cdr <any>/404_AccountNotFound/0/<any> - e/<any>/<any>/<any> -- i/<any>/<any> 
  Then done

Scenario: SS7 inbound FT portability (ORT -> FT) : SMG003-CPC-010-RED-4444-002-0-1-8888-1-5-3-1-0-IAM-0D00010021010A00020907039080012020000A07031780823710761D038090A303047D029181080180001EC08C9E1085DC45EF100100
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <100000000> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: 4444
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  Given header X-FreeTDM-RDINF-Indicator: 1
  Given header X-FreeTDM-RDINF-OrigReason: 5
  Given header X-FreeTDM-RDINF-Reason: 3
  Given header X-FreeTDM-RDINF-Count: 1
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 returning 10684
  Then add header X-FreeTDM-CPC: ordinary
  Then add header X-FreeTDM-Presentation: 0
  Then add header X-FreeTDM-Screen: 3
  Then add header X-FreeTDM-CLG-NADI: 4
  Then cdr <any>/D200912010001.1 - e/0991000001019/100000000/100000000/ALLOWED/<any> -- e/0991000001019/10684123456789 
  Then dial channel SIP/NSG with nadi 3, number 10684123456789-g=ORT and options 121
  Given release cause 16
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/100000000/100000000/ALLOWED/<any> -- e/0991000001019/10684123456789 
  Then done

Scenario: SS7 outbound FT portability (FT -> ORT) : SMG003-CPC-010
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <100000000> to 10025142740479
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33142740479 and find nothing
  Then query LIDB with 33142740479 and find nothing
  Then set callerIdNum to +33100000000
  Then add header P-Asserted-Identity: <tel:+33100000000>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33100000000/+33100000000/ALLOWED/<any> -- i/<any>/33142740479 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33142740479, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33100000000/+33100000000/ALLOWED/<any> -- i/<any>/33142740479 
  Then done

Scenario: SS7 inbound call : SMG003-CPC-010-RED-4444-002-0-1-8888-1-5-3-1-0-IAM-0D00010021010A00020907039080012020000A07031780823710761D038090A303047D029181080180001EC08C9E1085DC45EF100100
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456789> to 142740479
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: 4444
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  Given header X-FreeTDM-RDINF-Indicator: 1
  Given header X-FreeTDM-RDINF-OrigReason: 5
  Given header X-FreeTDM-RDINF-Reason: 3
  Given header X-FreeTDM-RDINF-Count: 1
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33142740479 and find nothing
  Then query LIDB with 33142740479 and find nothing
  Then set callerIdNum to +33123456789
  Then add header P-Asserted-Identity: <tel:+33123456789>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456789/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33142740479, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456789/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then done

Scenario: SS7 inbound call (ISUP bizarre: premier champs RED vide) SMG003-CPC-010-RED--000-0-0-800009053-3-0-0-1-0
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  Given header X-FreeTDM-RDNIS-NADI: 000
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 800009053
  Given header X-FreeTDM-RDINF-Indicator: 3
  Given header X-FreeTDM-RDINF-OrigReason: 0
  Given header X-FreeTDM-RDINF-Reason: 0
  Given header X-FreeTDM-RDINF-Count: 1
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call (GenAddress with a 4 number callingNumber) :  SMG003-CPC-010-GEN-000-3312-003-0-0-1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 3312
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 0
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call (GenAddress with a 9 number callingNumber) : SMG003-CPC-010-GEN-000-144927860-003-0-0-1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 144927860
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 0
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33144927860
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33144927860/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33144927860/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call (GenAddress with a 10 number callingNumber) : SMG003-CPC-010-GEN-000-0144927860-003-0-0-1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 0144927860
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 0
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call (caller id in ISUP only) : SMG003-CPC-010-GEN-000-0534010636-003-0-0-1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 534010636
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 0
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33970755000
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33534010636
  Then add header P-Asserted-Identity: <tel:+33970755000>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33534010636/+33970755000/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33534010636/+33970755000/ALLOWED/<any> -- i/<any>/33123456789
  Then done 

Scenario: SS7 inbound (carrier/account in env.) : SMG003-CPC-010-RED-4444-002-0-1-8888-1-5-3-1-0-IAM-0D00010021010A00020907039080012020000A07031780823710761D038090A303047D029181080180001EC08C9E1085DC45EF100100
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456789> to 142740479
  Given account code 0991000000000
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: 4444
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  Given header X-FreeTDM-RDINF-Indicator: 1
  Given header X-FreeTDM-RDINF-OrigReason: 0
  Given header X-FreeTDM-RDINF-Reason: 0
  Given header X-FreeTDM-RDINF-Count: 1
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000000000 returning out_plan: e164, in_plan: e164, carrier_code: D210001010001.1, locked: false
  Then query NPDB by 33142740479 and find nothing
  Then query LIDB with 33142740479 and find nothing
  Then set callerIdNum to +33123456789
  Then add header P-Asserted-Identity: <tel:+33123456789>
  Then add header X-AccountCode: 0991000000000
  Then add header X-CarrierCode: D210001010001.1
  Then cdr <any>/D210001010001.1 - e/0991000000000/+33123456789/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33142740479, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D210001010001.1 - e/0991000000000/+33123456789/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then done

Scenario: SS7 redirection 1/2 : SMG003-CPC-010
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and return redirect_to: 33000000002
  Then redirect from 003123456789 to 000000002
  Given answered time 0
  Then complete cdr <any>/200_Redirection/0/D200912010001.1 - e/0991000001019/123456780/123456780/ALLOWED/<any> -- e/0991000001019/000000002
  Then done

Scenario: SS7 redirection 2/2: redirect to us
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 000000002
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from 003123456789
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33000000002 and find nothing
  Then query LIDB with 33000000002 and return account_code: 0990000001111, out_plan: e164, in_plan: e164, trunk: true
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1	
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33000000002
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33000000002, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33000000002
  Then done

Scenario: SS7 redirection when already redirected too many times : SMG003-CPC-010-RED-123456788-003-1-1-123456788-3-3-3-5-0
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: 123456788
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 1
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 123456788
  Given header X-FreeTDM-RDINF-Indicator: 3
  Given header X-FreeTDM-RDINF-OrigReason: 3
  Given header X-FreeTDM-RDINF-Reason: 3
  Given header X-FreeTDM-RDINF-Count: 5
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and return redirect_to: 33123456788
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789 
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: Generic Number NADI a 1, on utilise le callerID : SMG003-CPC-010-GEN-000-111111111-001-0-0-1-RED--003-0-1-800009053-3-0-0-1-0
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456789> to 142740479
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 111111111
  Given header X-FreeTDM-GN-NADI: 1
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 0
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <nil>
  Given header X-FreeTDM-RDNIS-NADI: 3
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 800009053
  Given header X-FreeTDM-RDINF-Indicator: 3
  Given header X-FreeTDM-RDINF-OrigReason: 0
  Given header X-FreeTDM-RDINF-Reason: 0
  Given header X-FreeTDM-RDINF-Count: 1
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33142740479 and find nothing
  Then query LIDB with 33142740479 and find nothing
  Then set callerIdNum to +33123456789
  Then add header P-Asserted-Identity: <tel:+33123456789>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456789/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33142740479, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456789/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then done

Scenario: GenericNumber NADI a 3, on utilise le GenericNumber : SMG003-CPC-010-GEN-000-111111111-003-0-0-1-RED--003-0-1-800009053-3-0-0-1-0
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456789> to 142740479
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 111111111
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 0
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <nil>
  Given header X-FreeTDM-RDNIS-NADI: 3
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 800009053
  Given header X-FreeTDM-RDINF-Indicator: 3
  Given header X-FreeTDM-RDINF-OrigReason: 0
  Given header X-FreeTDM-RDINF-Reason: 0
  Given header X-FreeTDM-RDINF-Count: 1
  Given header X-FreeTDM-RDINF-Reserved: 0
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33142740479 and find nothing
  Then query LIDB with 33142740479 and find nothing
  Then set callerIdNum to +33111111111
  Then add header P-Asserted-Identity: <tel:+33123456789>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33111111111/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33142740479, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33111111111/+33123456789/ALLOWED/<any> -- i/<any>/33142740479
  Then done

Scenario: SS7 anonymous inbound call without GEN adress : SMG003-CPC-010
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 0
  Given header X-FreeTDM-Presentation: 1
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header Privacy: id
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 anonymous inbound call without GEN adress : SMG003-CPC-010 - Presentation different from 0 or 1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 0
  Given header X-FreeTDM-Presentation: 2
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header Privacy: id
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 anonymous inbound call with a 9 GenNumber callingNumber : SMG003-CPC-010-GEN-000-144927860-003-3-1-1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 144927860
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 1
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33144927860
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header Privacy: id
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33144927860/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33144927860/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 anonymous inbound call with a 9 GenNumber callingNumber : SMG003-CPC-010-GEN-000-144927860-003-3-1-1 - Presentation different from 0 or 1
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 144927860
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 2
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33144927860
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header Privacy: id
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33144927860/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33144927860/+33123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then done

Scenario: limites atteintes
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, max_calls: 2, call_count: 2
  Then hangup with cause 31
  Given answered time 0
  Then complete cdr <any>/480_LimitReached/0/<any> - e/<any>/<any>/<any> -- i/<any>/<any> 
  Then done

Scenario: locked
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: true
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: pas de numero appelant
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false, subscriber_number: 33970755000
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33970755000
  Then add header P-Asserted-Identity: <tel:+33970755000>
  Then add header Privacy: id
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33970755000/+33970755000/RESTRICTED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33970755000/+33970755000/RESTRICTED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call with valid GN set to international (GN-NADI: 4)
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 4
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 6
  Given header X-FreeTDM-GN: 123456781
  Given header X-FreeTDM-GN-NADI: 4
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 1
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +123456781
  Then add header P-Asserted-Identity: <tel:+123456780>
  Then add header Privacy: id
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+123456781/+123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+123456781/+123456780/RESTRICTED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call with invalid GN (GN-NADI: 2)
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 6
  Given header X-FreeTDM-GN: 3312
  Given header X-FreeTDM-GN-NADI: 2
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 1
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: SS7 inbound call with invalid GN (GN-NumQual: 0)
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN-NumQual: 0
  Given header X-FreeTDM-GN: 3312
  Given header X-FreeTDM-GN-NADI: 3
  Given header X-FreeTDM-GN-Screen: 0
  Given header X-FreeTDM-GN-Presentation: 1
  Given header X-FreeTDM-GN-Plan: 1
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: no CPC
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: <null>
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: invalid RDNIS because of invalid CPC
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: InVaLiD
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: 4444
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: invalid RDNIS because too long
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: 33111111111111111111111111111111
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: invalid RDNIS because empty
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: invalid RDNIS because no GN-NumQual
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: 1234
  Given header X-FreeTDM-GN-NumQual: <null>
  Given header X-FreeTDM-RDNIS: 4444
  Given header X-FreeTDM-RDNIS-NADI: 002
  Given header X-FreeTDM-RDNIS-Presentation: 0
  Given header X-FreeTDM-RDNIS-Plan: 1
  Given header X-FreeTDM-RDNIS-Orig: 8888
  Given header X-FreeTDM-RDINF-Indicator: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then dial channel SIP/GW with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: Invalid ISUP, no CLD-NADI (same as no CLG-NADI and no CLG-Pres)
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: <null>
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then hangup with cause 38
  Given answered time 0
  Then complete cdr <any> 500/Error 0
  Then done

Scenario: avec un niveau de failover - timeout et peer inconu - devrait etre le meme cas que 408
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 111
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: avec un niveau de failover - timeout et peer inconu - annulation apres avoir reussi le fail-over
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 111
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 111
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: avec un niveau de failover - 408
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 18
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: failover echoue
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 18
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 18
  Given dial status CHANUNAVAIL
  Then hangup with cause 19
  Given answered time 0
  Then complete cdr <any> 480/NoGatewayAvailable 0
  Then done

Scenario: avec plusieurs niveaux de failover - 500 a 504
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2,SIP/GW3,SIP/GW4,SIP/GW5,SIP/GW6
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 6 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 38
  Given dial status CHANUNAVAIL
  Then rand 0 with 5 gateways
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 29
  Given dial status CHANUNAVAIL
  Then rand 0 with 4 gateways
  Then dial channel SIP/GW3 with number 33123456789, timeout 120 and separator ,
  Given release cause 27
  Given dial status CHANUNAVAIL
  Then rand 0 with 3 gateways
  Then dial channel SIP/GW4 with number 33123456789, timeout 120 and separator ,
  Given release cause 34
  Given dial status CHANUNAVAIL
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW5 with number 33123456789, timeout 120 and separator ,
  Given release cause 102
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW6 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: avec un niveau de failover - code par dfaut pour la plage 5XX
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 34
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: avec un niveau de failover - le probing a detecte que routag ne repond pas
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 20
  Given dial status CHANUNAVAIL
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: loadbalancing, tirage de la premiere gateways
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 0 with 2 gateways
  Then dial channel SIP/GW1 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: loadbalancing, tirage de la seconde gateways
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW1,SIP/GW2
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 returning out_plan: e164, in_plan: e164, carrier_code: D200912010001.1, locked: false
  Then query NPDB by 33123456789 and find nothing
  Then query LIDB with 33123456789 and find nothing
  Then set callerIdNum to +33123456780
  Then add header P-Asserted-Identity: <tel:+33123456780>
  Then add header X-AccountCode: 0991000001019
  Then add header X-CarrierCode: D200912010001.1
  Then cdr <any>/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then set P-Charging-Vector
  Then rand 1 with 2 gateways
  Then dial channel SIP/GW2 with number 33123456789, timeout 120 and separator ,
  Given release cause 16
  Given dial status ANSWER
  Then hangup with cause 16
  Given answered time 1234
  Then complete cdr <any>/200_Answered/1234/D200912010001.1 - e/0991000001019/+33123456780/+33123456780/ALLOWED/<any> -- i/<any>/33123456789
  Then done

Scenario: EXDB returns nothing when querying with AccountCode
  Given ss7.Ss7InboundAgi and inbound_timeout: 120, outbound_timeout: 121, ft_chan: FT, op_chan: ORT, nsg_chan: SIP/NSG, gw_chan: SIP/GW
  Given a call from Jean Bon <123456780> to 123456789
  Given account code 0991000001019
  Given header X-FreeTDM-CPC: ordinary
  Given header X-FreeTDM-CLD-NADI: 3
  Given header X-FreeTDM-CLG-NADI: 3
  Given header X-FreeTDM-Screen: 3
  Given header X-FreeTDM-Presentation: 0
  Given header X-FreeTDM-GN: <null>
  Given header X-FreeTDM-RDNIS: <null>
  When redirecting from <null>
  Then query EXDB with 0991000001019 and find nothing
  Then hangup with cause 21
  Given answered time 0
  Then complete cdr <any> 403/AccountNotFound 0
  Then done
