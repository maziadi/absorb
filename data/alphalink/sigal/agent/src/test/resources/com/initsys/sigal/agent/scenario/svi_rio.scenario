Scenario: nominal, numero identifie, RIO connu et date de fin d'engagement
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 returning msisdn: 33000000000, rio: 12P4ABC, date: 1970-01-01T00:00:00+00:00
	Then cdr abcdef1234567890/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then send sms with msisdn: 33000000000, rio: 12P4ABC, date: 1970-01-01T00:00:00+00:00
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/welcome_date with escape digit 8 and press <null>
  Then say date time 1970-01-01T00:00:00+00:00 with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/rio_is with escape digit 8 and press <null>
  Then say rio 12P4ABC with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/sms with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 16
	Given answered time 1234
	Then complete cdr abcdef1234567890/200_Answered/1234/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: numero identifie, RIO connu et pas de date de fin d'engagement
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 returning msisdn: 33000000000, rio: 12P4ABC, date: <null>
	Then cdr abcdef1234567890/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then send sms with msisdn: 33000000000, rio: 12P4ABC, date: <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/welcome_no_date with escape digit 8 and press <null>
  Then say rio 12P4ABC with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/sms with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 16
	Given answered time 1234
	Then complete cdr abcdef1234567890/200_Answered/1234/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: numero identifie, RIO connu et ligne d'entreprise
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 returning msisdn: 33000000000, rio: 12E4ABC, date: <null>
	Then cdr abcdef1234567890/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/entreprise with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 16
	Given answered time 1234
	Then complete cdr abcdef1234567890/200_Answered/1234/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: numero inconnu
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 and find nothing
	Then cdr abcdef1234567890/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/unknown with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 16
	Given answered time 1234
	Then complete cdr abcdef1234567890/200_Answered/1234/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: pas de reponse du SI
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 and get timeout
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/unavailable with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
  Then noop Timeout occured while handling call Jean Bon <+33000000000>, ext=33123456789, channel=SIP/xyzetodo, TODO, no details.
  Then hangup with cause 38
  Given answered time 0
  Then complete cdr <any> 500/Timeout 0
  Then done

Scenario: erreur JMS
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 and get exception
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/unavailable with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 38
	Given answered time 1234
	Then complete cdr abcdef1234567890/500_Error/1234/carrier_code - i/0991000001017/+33000000000/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: cas nominal avec callerid diff√©rent du PAI
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000001> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: <null>
  Then answer
	Then query SviRio with 33000000000 returning msisdn: 33000000000, rio: 12P4ABC, date: 1970-01-01T00:00:00+00:00
	Then cdr abcdef1234567890/carrier_code - i/0991000001017/+33000000001/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then send sms with msisdn: 33000000000, rio: 12P4ABC, date: 1970-01-01T00:00:00+00:00
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/welcome_date with escape digit 8 and press <null>
  Then say date time 1970-01-01T00:00:00+00:00 with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/rio_is with escape digit 8 and press <null>
  Then say rio 12P4ABC with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/sms with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 16
	Given answered time 1234
	Then complete cdr abcdef1234567890/200_Answered/1234/carrier_code - i/0991000001017/+33000000001/+33000000000/ALLOWED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: cas nominal sans PAI
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <null>
	Given header Privacy: <null>
	Then hangup with cause 21
	Given answered time 0
	Then complete cdr <any>/403_MissingIdentity/0/<any> - i/<any>/<any>/<any> -- e/<any>/<any>
  Then done

Scenario: cas nominal avec Privacy: id
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000001> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and return max_calls: 2, call_count: 1, out_plan: e164, in_plan: e164
	Given header P-Asserted-Identity: <tel:+33000000000>
	Given header Privacy: id
  Then answer
	Then query SviRio with 33000000000 returning msisdn: 33000000000, rio: 12P4ABC, date: 1970-01-01T00:00:00+00:00
	Then cdr abcdef1234567890/carrier_code - i/0991000001017/+33000000001/+33000000000/RESTRICTED/Jean Bon -- e/0990000000002/33123456789
  Then send sms with msisdn: 33000000000, rio: 12P4ABC, date: 1970-01-01T00:00:00+00:00
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/welcome_date with escape digit 8 and press <null>
  Then say date time 1970-01-01T00:00:00+00:00 with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/rio_is with escape digit 8 and press <null>
  Then say rio 12P4ABC with escape digit 8 and press <null>
  Then stream file /var/lib/asterisk/sounds/svi_rio_films/sms with escape digit 8 and press <null>
  Then wait for digit 8 3000 miliseconds and press <null>
	Then hangup with cause 16
	Given answered time 1234
	Then complete cdr abcdef1234567890/200_Answered/1234/carrier_code - i/0991000001017/+33000000001/+33000000000/RESTRICTED/Jean Bon -- e/0990000000002/33123456789
  Then done

Scenario: LIDB returns nothing when querying with AccountCode
	Given mrf5.SviRioAgi and gw_channel_name: SIP/gw
	Given a call to svi rio from Jean Bon <+33000000000> to 33123456789 within carrier_code
	Given icid abcdef1234567890
	Given account code 0991000001017
	Given SIP DOMAIN 0990000000002.mrf-10.sip.openvno.net
	Then query LIDB with 33123456789 and find nothing
  Then hangup with cause 21
  Given answered time 0
  Then complete cdr <any> 403/AccountNotFound 0
  Then done
