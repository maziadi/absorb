<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:amq="http://activemq.apache.org/schema/core" xmlns:jms="http://www.springframework.org/schema/jms"
	xmlns:ctx="http://www.springframework.org/schema/context" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd
  http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms-2.5.xsd
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

	<ctx:property-placeholder properties-ref="cmProps" />


	<!-- JMS setup -->
	<bean id="requestDestination" class="org.apache.activemq.command.ActiveMQQueue">
		<constructor-arg value="${sigal.dbQueueName}.query" />
	</bean>

	<bean id="cdrQueueDestination" class="org.apache.activemq.command.ActiveMQQueue">
		<constructor-arg value="${sigal.cdrQueueName}" />
	</bean>

	<bean id="cdrTopicDestination" class="org.apache.activemq.command.ActiveMQTopic">
		<constructor-arg value="${sigal.cdrTopicName}" />
	</bean>

	<bean id="stompQueueName" class="org.apache.activemq.command.ActiveMQQueue">
		<constructor-arg value="${si.stompQueueName}" />
	</bean>

	<bean id="primaryConnectionFactory"
		class="org.springframework.jms.connection.SingleConnectionFactory">
		<property name="targetConnectionFactory">
			<bean id="primaryJmsConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory"
				destroy-method="stop">
				<property name="connectionFactory">
					<bean class="org.apache.activemq.ActiveMQConnectionFactory">
						<property name="brokerURL" value="${amq.primary.brokerUrl}" />
						<property name="userName" value="${amq.primary.username}" />
						<property name="password" value="${amq.primary.password}" />
					</bean>
				</property>
			</bean>
		</property>
	</bean>

	<bean id="secondaryConnectionFactory"
		class="org.springframework.jms.connection.SingleConnectionFactory">
		<property name="targetConnectionFactory">
			<bean id="secondaryJmsConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory"
				destroy-method="stop">
				<property name="connectionFactory">
					<bean class="org.apache.activemq.ActiveMQConnectionFactory">
						<property name="brokerURL" value="${amq.secondary.brokerUrl}" />
						<property name="userName" value="${amq.secondary.username}" />
						<property name="password" value="${amq.secondary.password}" />
					</bean>
				</property>
			</bean>
		</property>
	</bean>

	<bean id="messageConverter" class="com.initsys.sigal.SigalMessageConverter" />

	<bean id="primarySigalTemplate" class="com.initsys.sigal.SigalTemplateImpl">
		<property name="template" ref="primaryJmsTemplate" />
		<property name="requestDestination" ref="requestDestination" />
		<property name="requestTimeout" value="${sigal.requestTimeout}" />
	</bean>

	<bean id="primaryJmsTemplate" class="com.initsys.sigal.SigalJmsTemplate">
		<property name="timeToLive" value="${jms.timeToLive}" />
		<property name="connectionFactory" ref="primaryConnectionFactory" />
		<property name="messageConverter" ref="messageConverter" />
		<property name="exceptionListener" ref="primarySigalTemplate" />
	</bean>

	<bean id="secondarySigalTemplate" class="com.initsys.sigal.SigalTemplateImpl">
		<property name="template" ref="secondaryJmsTemplate" />
		<property name="requestDestination" ref="requestDestination" />
		<property name="requestTimeout" value="${sigal.requestTimeout}" />
	</bean>

	<bean id="secondaryJmsTemplate" class="com.initsys.sigal.SigalJmsTemplate">
		<property name="timeToLive" value="${jms.timeToLive}" />
		<property name="connectionFactory" ref="secondaryConnectionFactory" />
		<property name="messageConverter" ref="messageConverter" />
		<property name="exceptionListener" ref="secondarySigalTemplate" />
	</bean>

	<bean id="messagingGateway"
		class="com.initsys.sigal.agent.FailoverSigalAgentMessagingGateway">
		<property name="primaryTemplate" ref="primarySigalTemplate" />
		<property name="secondaryTemplate" ref="secondarySigalTemplate" />
		<property name="cdrQueueDestination" ref="cdrQueueDestination" />
		<property name="cdrTopicDestination" ref="cdrTopicDestination" />
		<property name="maxFailureCount" value="${amq.failover.failureCount}" />
	</bean>

	<bean id="siMessageConverter" class="com.initsys.sigal.SiMessageConverter" />

	<bean id="siConnectionFactory"
		class="org.springframework.jms.connection.SingleConnectionFactory">
		<property name="targetConnectionFactory">
			<bean id="siJmsConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory"
				destroy-method="stop">
				<property name="connectionFactory">
					<bean class="org.apache.activemq.ActiveMQConnectionFactory">
						<property name="brokerURL" value="${amq.si.brokerUrl}" />
						<property name="userName" value="${amq.si.username}" />
						<property name="password" value="${amq.si.password}" />
					</bean>
				</property>
			</bean>
		</property>
	</bean>
  
	<bean id="siJmsTemplate" class="com.initsys.sigal.SigalJmsTemplate">
		<property name="timeToLive" value="${jms.timeToLive}" />
		<property name="connectionFactory" ref="siConnectionFactory" />
		<property name="messageConverter" ref="siMessageConverter" />
		<property name="exceptionListener" ref="siTemplate" />
	</bean>

  <bean id="siTemplate" class="com.initsys.sigal.SigalTemplateImpl">
		<property name="template" ref="siJmsTemplate" />
    <property name="requestDestination" ref="stompQueueName" />
		<property name="requestTimeout" value="${si.requestTimeout}" />
	</bean>

  <bean id="siMessagingGateway" 
		class="com.initsys.sigal.agent.SiAgentMessagingGateway">
		<property name="siTemplate" ref="siTemplate" />
        <property name="smsStringNoDate" value="${svi.rio.sms.noDate}" />
        <property name="smsStringDate" value="${svi.rio.sms.date}" />
        <property name="smsStringRio" value="${svi.rio.sms.rio}" />
  </bean>

	<!-- AGI setup -->
	<bean id="agiServer" class="org.asteriskjava.fastagi.DefaultAgiServer">
		<property name="port" value="${agi.server.port}" />
		<property name="poolSize" value="${agi.server.poolSize}" />
		<property name="maximumPoolSize" value="${agi.server.maximumPoolSize}" />
		<property name="mappingStrategy" ref="mappingStrategy" />
	</bean>

	<bean id="agiServerThread" class="org.asteriskjava.fastagi.AgiServerThread"
		init-method="startup" destroy-method="shutdown">
		<property name="agiServer" ref="agiServer" />
	</bean>

	<bean id="inboundStatistics" class="com.initsys.sigal.agent.AgentStatisticsImpl">
		<property name="type" value="IN" />
	</bean>

	<bean id="outboundStatistics" class="com.initsys.sigal.agent.AgentStatisticsImpl">
		<property name="type" value="OUT" />
	</bean>

	<bean id="abstractSigalAgi" abstract="true">
		<property name="template" ref="messagingGateway" />
		<property name="outEstablishmentTimeout" value="${out.establishmentTimeout}" />
		<property name="inEstablishmentTimeout" value="${in.establishmentTimeout}" />
		<property name="nodeName" value="${sigal.nodeName}" />
	</bean>

	<bean id="abstractFtAgi" parent="abstractSigalAgi" abstract="true">
		<property name="ftChannelName" value="${out.ftChannelName}" />
		<property name="opChannelName" value="${out.opChannelName}" />
    <property name="nsgChannelName" value="${out.nsgChannelName}" />
	</bean>

	<bean id="mappingStrategy" class="org.asteriskjava.fastagi.SimpleMappingStrategy">
		<property name="mappings">
			<map>
				<entry key="ss7Inbound.agi">
					<bean id="ss7InboundAgiAgi" class="com.initsys.sigal.agent.agi.ss7.Ss7InboundAgi"
						parent="abstractFtAgi">
						<property name="gwChannelName" value="${inboundGwChannelName}" />
						<property name="statistics" ref="inboundStatistics" />
					</bean>
				</entry>
				<entry key="ss7Outbound.agi">
					<bean id="ss7OutboundAgi" class="com.initsys.sigal.agent.agi.ss7.Ss7OutboundAgi"
						parent="abstractFtAgi">
						<property name="statistics" ref="outboundStatistics" />
					</bean>
				</entry>
				<entry key="mobileForcedRouting.agi">
					<bean id="mobileForcedRoutingAgiAgi" class="com.initsys.sigal.agent.agi.ss7.MobileForcedRoutingAgi"
						parent="abstractFtAgi">
						<property name="gwChannelName" value="${inboundGwChannelName}" />
						<property name="statistics" ref="inboundStatistics" />
					</bean>
				</entry>
				<entry key="sviRio.agi">
					<bean id="sviRioAgi" class="com.initsys.sigal.agent.agi.mrf5.SviRioAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${outboundGwChannelName}" />
						<property name="inboundGwChannelName" value="${inboundGwChannelName}" />
						<property name="statistics" ref="outboundStatistics" />
                        <property name="sviRioTemplate" ref="siMessagingGateway" />
					</bean>
				</entry>
				<entry key="mrf5Outbound.agi">
					<bean id="mrf5OutboundAgi" class="com.initsys.sigal.agent.agi.mrf5.Mrf5OutboundAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${outboundGwChannelName}" />
						<property name="inboundGwChannelName" value="${inboundGwChannelName}" />
						<property name="statistics" ref="outboundStatistics" />
					</bean>
				</entry>
				<entry key="mrf5Inbound.agi">
					<bean id="mrf5InboundAgi" class="com.initsys.sigal.agent.agi.mrf5.Mrf5InboundAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${inboundGwChannelName}" />
						<property name="emergencyNumbers" value="${out.emergencyNumbers}" />
						<property name="handleLocalCalls" value="${out.handleLocalCalls}" />
						<property name="statistics" ref="inboundStatistics" />
					</bean>
				</entry>
				<entry key="mrf4Outbound.agi">
					<bean id="mrf4OutboundAgi" class="com.initsys.sigal.agent.agi.mrf4.Mrf4OutboundAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${outboundGwChannelName}" />
						<property name="statistics" ref="outboundStatistics" />
					</bean>
				</entry>
				<entry key="mrf4Inbound.agi">
					<bean id="mrf4InboundAgi" class="com.initsys.sigal.agent.agi.mrf4.Mrf4InboundAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${inboundGwChannelName}" />
						<property name="statistics" ref="inboundStatistics" />
					</bean>
				</entry>
				<entry key="isdnOutbound.agi">
					<bean id="isdnOutboundAgi" class="com.initsys.sigal.agent.agi.isdn.IsdnOutboundAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${outboundGwChannelName}" />
						<property name="statistics" ref="outboundStatistics" />
					</bean>
				</entry>
				<entry key="isdnInbound.agi">
					<bean id="isdnInboundAgi" class="com.initsys.sigal.agent.agi.isdn.IsdnInboundAgi"
						parent="abstractSigalAgi">
						<property name="gwChannelName" value="${inboundGwChannelName}" />
						<property name="statistics" ref="inboundStatistics" />
					</bean>
				</entry>
			</map>
		</property>
	</bean>


	<!-- Scheduled tasks -->
	<bean id="timerFactory" class="org.springframework.scheduling.timer.TimerFactoryBean">
		<property name="scheduledTimerTasks">
			<list>
				<bean id="scheduledLogInboundStatistics"
					class="org.springframework.scheduling.timer.ScheduledTimerTask">
					<property name="delay" value="60000" />
					<property name="period" value="120000" />
					<property name="fixedRate" value="true" />
					<property name="timerTask">
						<bean
							class="org.springframework.scheduling.timer.MethodInvokingTimerTaskFactoryBean">
							<property name="targetObject" ref="inboundStatistics" />
							<property name="targetMethod" value="log" />
						</bean>
					</property>
				</bean>
				<bean id="scheduledLogOutboundStatistics"
					class="org.springframework.scheduling.timer.ScheduledTimerTask">
					<property name="delay" value="60000" />
					<property name="period" value="120000" />
					<property name="fixedRate" value="true" />
					<property name="timerTask">
						<bean
							class="org.springframework.scheduling.timer.MethodInvokingTimerTaskFactoryBean">
							<property name="targetObject" ref="outboundStatistics" />
							<property name="targetMethod" value="log" />
						</bean>
					</property>
				</bean>
			</list>
		</property>
	</bean>


	<!-- Management -->
	<bean id="mBeanExporter" class="org.springframework.jmx.export.MBeanExporter"
		lazy-init="false">
		
		<property name="beans">
			<map>
				<entry key="sigal:name=agent-statistics-outbound" value-ref="outboundStatistics" />
				<entry key="sigal:name=agent-statistics-inbound" value-ref="inboundStatistics" />
			</map>
		</property>
	</bean>
</beans>
