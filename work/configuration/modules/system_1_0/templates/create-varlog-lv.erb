#!/bin/bash

logger=$(lsof | grep -E '^(rsyslog|syslog-ng).*var/log' | head -n 1 | grep -Eo '^(rsyslog|syslog-ng)')

lvcreate -L <%= varlog_lv_size -%> -n var_log <%= varlog_vg_name -%> || exit -1
mkfs.xfs /dev/mapper/<%= varlog_vg_name -%>-var_log || exit -2
mkdir -p /mnt/var_log || exit -3
if [ ! $(grep -q "/dev/mapper/<%= varlog_vg_name -%>-var_log" /etc/fstab) ]
  then
  echo "/dev/mapper/<%= varlog_vg_name -%>-var_log /var/log xfs defaults 0 2" >> /etc/fstab || exit -4
fi
mount /dev/mapper/<%= varlog_vg_name -%>-var_log /mnt/var_log || exit -5
/etc/init.d/${logger} stop || exit -6
if [ -n "$(lsof | grep '/var/log' | grep -v '^tail')" ]
  then
  echo "Merci de couper tous les services logguant dans /var/log et de relancer le script a la main"
  /etc/init.d/${logger} start
  umount /mnt/var_log
  lvremove -f /dev/mapper/<%= varlog_vg_name -%>-var_log
  exit -7
fi

mv /var/log/* /mnt/var_log/ || exit -8
mount /var/log || exit -9
/etc/init.d/${logger} start || exit -10
umount /mnt/var_log || exit -11
