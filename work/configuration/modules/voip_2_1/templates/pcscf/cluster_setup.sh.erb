#!/bin/bash

failed()
{
  echo "An error occurred" >&2
  exit 1
}

list_sets()
{
  grep set_id /etc/slony1/slon_tools.conf | sed -e 's/.*"set_id" => \([0-9]\+\),/\1/'
}

DB1=opensips
DB2=opensips
H1=pcscf-postgres-main.openvno.net
H2=pcscf-postgres-secondary.openvno.net
U1=postgres
U2=postgres

echo "Creating languages plpgsql on all nodes"
/usr/lib/postgresql/8.4/bin/createlang -U $U1 -h $H1 plpgsql $DB1
/usr/lib/postgresql/8.4/bin/createlang -U $U2 -h $H2 plpgsql $DB2

echo "Creating function to detect slaves and master"
/usr/bin/psql opensips postgres -c "CREATE OR REPLACE FUNCTION f_is_slave() RETURNS BOOLEAN AS \$\$ BEGIN RETURN (count(*) > 0) FROM _pgsql_cluster.sl_subscribe JOIN _pgsql_cluster.sl_node ON sub_receiver = no_id JOIN _pgsql_cluster.sl_local_node_id ON no_id = last_value; END \$\$ LANGUAGE plpgsql;" || failed
echo "Initializing cluster"
/usr/bin/slonik_init_cluster|/usr/bin/slonik || failed
for s in $(list_sets); do
  echo "Starting replication of set $s"
  /usr/bin/slonik_create_set $s|/usr/bin/slonik || failed
done

echo "Restarting slony1 for opensips"
/usr/sbin/monit restart slony1_opensips || failed
