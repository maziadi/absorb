#!/bin/bash
#
# CRON
# Check for ACCT without STOP after 25h and send mail to noc-alert
#

. /opt/local/bin/lib-apn.sh

logger_tag="report-unstopped"

# exit if not executed on primary
ip a | grep <%= virtual_ip %> >/dev/null
if [ "$?" == "1" ]; then exit 0; fi

order="<"
if [ "$1" == "reverse" ]; then
  order=">"
fi

function getref() {
# $1 : msisdn
  local ref=""
  ref=$(su - postgres -c "psql -1 -d <%= db_name %> -c \"SELECT ref FROM refmsisdn WHERE refmsisdn.msisdn = '$1';\" -h <%= virtual_ip %>" | sed 's/ //g' | head -n 3 | tail -1)
  echo "$ref"
}

function getip() {
# $1 : username
  local ip=""
  ip=$(su - postgres -c "psql -1 -d <%= db_name %> -c \"SELECT value FROM radreply WHERE radreply.username = '$1' AND radreply.attribute = 'Framed-IP-Address';\" -h <%= virtual_ip %>" | sed 's/ //g' | head -n 3 | tail -1)
  echo "$ip"
}

# check unstopped sessions after 25h
fic=$(mktemp)
su - postgres -c "psql -1 -d <%= db_name %> -c \"SELECT * FROM radreply INNER JOIN (SELECT * FROM radacct WHERE acctsessionid NOT IN (SELECT acctsessionid FROM radacct WHERE acctstoptime IS NOT null)) AS radacct ON radacct.username = radreply.username AND acctstarttime $order (now() - interval '25 hour');\" -h <%= virtual_ip %>" | grep -v "^[[:space:]]\+id" | grep -v "^-" | grep -v "^(.*row" | grep -v "^$" > $fic
while read line
do
  found="J'ai abandonné la pêche le jour où je me suis aperçu qu'en les attrapant, les poissons ne frétillaient pas de joie - Louis de Funès"

  id=$(echo $line | cut -d'|' -f6 | sed 's/ //g')
  sessionid=$(echo $line | cut -d'|' -f7 | sed 's/ //g')
  username=$(echo $line | cut -d'|' -f9 | sed 's/ //g')
  msisdn=$(echo $username | cut -c1-11)
  ref=$(getref $msisdn)
  ip=$(getip $username)
  starttime=$(echo $line | cut -d'|' -f15| sed 's/+00//g')
  rx=$(echo $line | cut -d'|' -f21 | sed 's/ //g')
  tx=$(echo $line | cut -d'|' -f22 | sed 's/ //g')
  codemcc=$(echo $line | cut -d'|' -f33 | sed 's/ //g' | cut -c1-3)
  timezone=$(echo $line | cut -d'|' -f34 | sed 's/ //g')

  logger -t ${logger_tag} "[$ref-$sessionid] unstopped session"
  if [ ${#bodymail} == 0 ]; then
    dt=$(date +%F+%R)
    bodymail="At $dt, >25h unstopped session(s) !\n"
  fi
  bodymail="$bodymail\nsession id: $sessionid"
  bodymail="$bodymail\nstart time: $starttime"
  bodymail="$bodymail\nusername: $username"
  bodymail="$bodymail\nmsisdn: $msisdn"
  bodymail="$bodymail\nclient: $ref"
  bodymail="$bodymail\nip: $ip"
  bodymail="$bodymail\nmcc: $codemcc"
  bodymail="$bodymail\ntime zone: $timezone\n"

done < $fic
rm $fic

[ ${#found} != 0 ] && echo -e $bodymail
exit 0

