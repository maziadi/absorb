LoadPlugin postgresql
<Plugin postgresql>
  <Query "pg_stat_activity">
    Statement "SELECT count(*) AS count \
            , SUM(CASE WHEN state = 'active' THEN 1 ELSE 0 END) AS state_active \
            , SUM(CASE WHEN state = 'idle' THEN 1 ELSE 0 END) AS state_idle \
            , SUM(CASE WHEN state = 'idle in transaction' THEN 1 ELSE 0 END) AS state_idle_in_transaction \
            , SUM(CASE WHEN state = 'idle in transaction aborted' THEN 1 ELSE 0 END) AS state_idle_in_transaction_aborted \
            , SUM(CASE WHEN state = 'fastpath function call' THEN 1 ELSE 0 END) AS state_fastpath_function_call \
            , SUM(CASE WHEN state = 'disabled' THEN 1 ELSE 0 END) AS state_disabled \
            , SUM(CASE WHEN waiting THEN 1 ELSE 0 END) AS waiting \
            FROM pg_stat_activity"

    <Result>
      Type gauge
      InstancePrefix "count"
      ValuesFrom "count"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "state_active"
      ValuesFrom "state_active"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "state_idle"
      ValuesFrom "state_idle"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "state_idle_in_transaction"
      ValuesFrom "state_idle_in_transaction"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "state_idle_in_transaction_aborted"
      ValuesFrom "state_idle_in_transaction_aborted"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "state_fastpath_function_call"
      ValuesFrom "state_fastpath_function_call"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "state_disabled"
      ValuesFrom "state_disabled"
    </Result>

    <Result>
      Type gauge
      InstancePrefix "waiting"
      ValuesFrom "waiting"
    </Result>

  </Query>
  <Database postgres>
    Host "<%= host %>"
    Port "<%= port %>"
    User "<%= user %>"
    Password "<%= password %>"
    Query pg_stat_activity
<% query.each do |q| -%>
    Query <%= q %>
<% end -%>

  </Database>
</Plugin>
