#!/usr/bin/env ruby

require 'syslog'
Syslog.open("monitor_gw_stats")
unless File.exists?('/opt/pcscf_tools/Gemfile')
  Syslog.log(Syslog::LOG_ERR, "Pcscf tools not initilized")
  Syslog.close
  exit 0 # do not send mail every minutes because used in a cron
end

require 'bundler'
ENV["BUNDLE_PATH"] = "/opt/pcscf_tools/bundle"
ENV["BUNDLE_DISABLE_SHARED_GEMS"] = "1"
ENV["BUNDLE_GEMFILE"] = "/opt/pcscf_tools/Gemfile"
Bundler.setup
gems = Gem.loaded_specs.values.map { |g| g.name }
unless gems.include?('pg') and gems.include?('postgres')
  Syslog.log(Syslog::LOG_ERR, "Pcscf tools not initilized correctly")
  Syslog.close
  exit 0 # do not send mail every minutes because used in a cron
end

require 'sequel'
require 'time'
require 'net/smtp'

$db = Sequel.connect(:adapter => 'postgres',
               :host => 'localhost',
               :database => 'opensips',
               :user => '<%= opensips_db_user %>',
               :password => '<%= opensips_db_password %>')

def update_or_create_status(address, status)
  last_status = $db[:gateways_status].filter(:address => address)
  if last_status.count >= 1
    last_status.update(:previous_status => last_status.first[:status], :last_modified => Time.now.iso8601, :status => status)
    { address => last_status.first }
  else
    $db[:gateways_status].insert(:address => address, :status => status)
    {}
  end
end

def get_old_status(address)
  gateways_status = $db[:gateways_status].filter(:address => address)
  gateways_status.count >= 1 ? gateways_status.first[:status] : nil
end

def list_new_status
  opensips_status = `/opt/local/bin/d201005050001_opensipsctl fifo dr_gw_status`.scan(/IP=([^ ]*) Enabled=([^\n]*)\n/)
  gws = $db[:d201005050001_dr_gw].filter(:probe_mode => 2).select(:address).map {|g| g[:address]}
  opensips_status.select {|k,v| gws.include?(k) }
end

def send_mail(new_status)
  gws_msg = []
  new_status.each do |gw, gw_status|
    gws_msg << "#{gw} switched to #{gw_status[:status]} and was #{gw_status[:previous_status]} since #{gw_status[:last_modified]}"
  end
  environment = File.read('/etc/puppet/puppet.conf').scan(/environment \= (\w+)/).first.first
  to = environment == 'production' ? 'noc-alerts@alphalink.fr' : 'dev-noc-alerts@alphalink.fr'
  hostname = `hostname`.strip
  from = "root@#{hostname}"
  msg = "From: <#{from}>
To: <#{to}>
Subject: PCSCF alert -- Gateways status changed
Changes happened in #{hostname}'s opensips gateways:

#{gws_msg.join("\n")}
  "
  Net::SMTP.start('mail.admin.alphalink.fr', 25) do |smtp|
    smtp.send_message(msg, from, to)
  end
end

new_status = {}
list_new_status.each do |address, status|
  db_status = (status.strip == 'no' ? 'down' : 'up')
  old_status = get_old_status(address)
  unless db_status == old_status
    new_status.merge!(update_or_create_status(address, db_status))
  end
end
send_mail(new_status) if new_status.size > 0
