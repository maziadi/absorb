#!/bin/bash

logencours=$(cat /var/log/syslog | awk '
BEGIN { cstart=0; cend=0 }
/Parsing.*chan_dahdi.conf/ { cstart=0; cend=0 }
/DAHDI\/[0-9]*-.*proceeding passing/ { cstart+=1 }
/Hungup.*DAHDI\/[0-9]*-/ { cend+=1 }
END { print cstart - cend }')

comencours=$(expr $(/usr/sbin/asterisk -rx 'core show channels concise' | wc -l) '/' 2)

delta=$(expr $logencours - $comencours | tr -d -)

[ $delta -gt 60 -a $delta -lt 99 ] && {
echo "Subject: <%= hostname %> - Probleme d'aboutissement
To: noc-alerts@alphalink.fr
Cc: a.moutot@alphalink.fr
Cc: c.leroy@alphalink.fr
Cc: t.amelin@alphalink.fr
Cc: s.rivier@alphalink.fr

Delta de coms entre les logs et asterisk : ${delta}
" | /usr/sbin/ssmtp noc-alerts@alphalink.fr a.moutot@alphalink.fr t.amelin@alphalink.fr c.leroy@alphalink.fr s.rivier@alphalink.fr
}
